angular.module("hashtalk",["ngSanitize","ngRoute","firebase","ui.gravatar"]).value("fbURL","https://hashtalk.firebaseio.com/messages").factory("notification",function(){var notification={send:jQuery.noop};if("external"in window&&external.getUnityObject){var Unity=external.getUnityObject(1);Unity.init({name:"HashTalk",iconUrl:document.location.origin+"/img/flaticon.png"}),notification.send=function(notif){Unity.Notification.showNotification(notif.title,notif.content)}}else"Notification"in window&&(notification.send=function(notif){if("granted"===Notification.permission)var notif=new Notification(notif.title,{body:notif.content,img:"img/flaticon.png"});else"denied"!==Notification.permission&&Notification.requestPermission(function(permission){if("permission"in Notification||(Notification.permission=permission),"granted"===permission)var notif=new Notification(notif.title,{body:notif.content,img:"img/flaticon.png"})})});return notification}).factory("Messages",function($rootScope,notification,$firebase,fbURL){return $firebase(new Firebase(fbURL))}).factory("socket",function(){return io.connect("hashtalk.herokuapp.com")}).controller("HTCtrl",function($scope,$route,$routeParams,$location,Messages,socket,$sce,notification){localStorage.pseudo&&($scope.pseudo=localStorage.pseudo,socket.emit("pseudo",$scope.pseudo)),$scope.messages=Messages,$scope.search={hashtag:"",pseudo:""},$scope.installable=!1,"mozApps"in navigator&&(navigator.mozApps.checkInstalled(location.href+"manifest.webapp").onsuccess=function(){this.result||($scope.installable=!0)}),$scope.install=function(){var installLocFind=navigator.mozApps.install(location.href+"manifest.webapp");installLocFind.onsuccess=function(){$scope.installable=!1},installLocFind.onerror=function(){console.error(installLocFind.error)}},$scope.submit=function(){$scope.postForm.$valid?(socket.emit("message",{msg:this.msg,hashtag:$scope.search.hashtag}),this.msg=""):console.error("Invalid",$scope.postForm.$valid)},$scope.setPseudo=function(){localStorage.pseudo!=$scope.pseudo&&(socket.emit("pseudo",$scope.pseudo),localStorage.pseudo=$scope.pseudo)},$scope.format=function(msg){if(msg.time=moment(msg.time).lang("fr").fromNow(),"message"==msg.type)msg.msg=msg.msg.replace(/\#(\S+)/g,function(match,hashtag){return"<a class=\"label label-primary\" onclick=\"angular.element('body').scope().$apply(function($scope){$scope.search.hashtag = '"+hashtag+'\';});" href="#">'+match+"</a>"}).replace(/\@(\S+)/g,function(match,pseudo){return"<a class=\"label label-success\" onclick=\"angular.element('body').scope().$apply(function($scope){$scope.search.pseudo = '"+pseudo+'\';});" href="#">'+match+"</a>"});else if("event"==msg.type){switch(msg.name){case"connect":msg.msg="joined the chat.";break;case"changed":msg.msg="changed his nickname to "+msg.new;break;case"disconnect":msg.msg="left the chat.";break;default:msg.msg="Something happened."}msg.msg=msg.msg.italics()}return msg.msg="file"==msg.type?$sce.trustAsResourceUrl("data:"+msg.type+";base64,"+msg.data):$sce.trustAsHtml(msg.msg),msg.pseudo.indexOf($scope.pseudo)>0&&notification.send({title:"Mention",content:msg.pseudo[0]+" mentionned you."}),console.log(msg),msg},$scope.msgFilter=function(value){return value.pseudo==$scope.pseudo||new RegExp("^.*"+$scope.search.hashtag+".*$","gi").test(value.hashtag)||""==$scope.search.hashtag||new RegExp("^.*"+$scope.search.pseudo+".*$","gi").test(value.pseudo)||""==$scope.search.pseudo},$(document.body).on("dragover",function(e){e.stopPropagation(),e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy",$("#postBox").addClass("drag")}).on("drop",function(e){e.stopPropagation(),e.preventDefault();for(var f,i=0;f=e.originalEvent.dataTransfer.files[i];i++){var stream=ss.createStream();ss(socket).emit("upload",stream,{type:f.type}),ss.createBlobReadStream(f).pipe(stream)}})});
